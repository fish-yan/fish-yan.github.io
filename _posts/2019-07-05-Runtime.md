---
layout:     post
title:      "Runtime tips"
subtitle:   "Runtime tips"
date:       2019-06-28 22:00:00
author:     "FishYan"
header-img: "img/blog-header.png" 
catalog:    true

---

## Tip1. self & super
有一个 Son 类继承 Father 类，在Son类中 [self class] 和 [super class] 的区别？
```swift
[self class] -> Son

[super class] -> Son
```
两个输出结果一样, 原因：
```swift
self 是当前类的隐藏参数，指向当前类，这个毫无疑问。

super 表面上和self是类似，指向父类。但实际并非如此，super 实际上是一个 Magic Keyword，它本身是一个编译标示符，和 self 是指向同一个消息接收者，
不同点在于 super 会告诉编译器，用super调用的方法，要去父类里面查找，而不是本类。
```
runtime中表示
```swift
[self class]

id objc_msgSend(id self, SEL op, ...)
```
```swift
[super class]

id objc_msgSendSuper(struct objc_super *super, SEL op, ...)

// 其中objc_super是一个结构体：

struct objc_super {
      __unsafe_unretained id receiver;
      __unsafe_unretained Class super_class;
};
```
receiver 是消息接受者

super_class 记录的是父类是什么

先看 `[self class]` 实现：
```
- (Class)class {
   return object_getClass(self);
}
```
当调用 `[super class]` 时，会转换为 `objc_msgSendSuper` 函数。

- 第一步：先构建 `objc_supe`r结构体

  - 第一个参数为 `self `
  - 第二个参数，通过```(id)class_getSuperclass(objc_getClass(“Son”))```获取父类
- 第二步：调用 `-（Class）class` 函数, 先在 `Father` 类中查找，没有 `class` 函数，再向父类 NSObject 中查找，有 `class` 函数，最后内部使用的是 ` objc_msgSend(objc_super->reciver, @selector(class))  `去调用，`objc_super->reciver` 即为 `self` ，此时与 `[self class]` 无异，所以输出结果为 `Son`

